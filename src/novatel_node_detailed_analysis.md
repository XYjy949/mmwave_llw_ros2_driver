# NovatelèŠ‚ç‚¹ä»£ç è¯¦ç»†åˆ†æ

## ğŸ“‹ å…¨å±€æ¦‚è§ˆ

è¿™ä¸ªä»£ç å®ç°äº†ä¸€ä¸ª**ROS2èŠ‚ç‚¹**ï¼Œå……å½“GPS/IMUå’Œæ¯«ç±³æ³¢é›·è¾¾ä¹‹é—´çš„**æ•°æ®ç½‘å…³å’Œé…ç½®ç®¡ç†å™¨**ã€‚

æ ¸å¿ƒèŒè´£ï¼š
- ğŸ”— æ¥æ”¶å¤šä¸ªROS2ä¸»é¢˜çš„æ•°æ®
- ğŸ”„ è½¬æ¢ä¸ºé›·è¾¾èƒ½ç†è§£çš„äºŒè¿›åˆ¶åè®®æ ¼å¼
- ğŸ“¡ é€šè¿‡UDPå‘é€ç»™é›·è¾¾
- âš™ï¸ å¤„ç†é›·è¾¾çš„é…ç½®å’Œå‚æ•°è®¾ç½®

---

## ğŸ—ï¸ ä»£ç ç»“æ„è¯¦è§£

### ç¬¬ä¸€éƒ¨åˆ†ï¼šå¤´æ–‡ä»¶å’Œç±»å®šä¹‰

```cpp
#include "rclcpp/rclcpp.hpp"                    // ROS2åŸºç¡€åº“
#include "std_msgs/msg/string.hpp"              // å­—ç¬¦ä¸²æ¶ˆæ¯
#include "udp_interface.h"                       // è‡ªå®šä¹‰UDPæ¥å£
#include "novatel_oem7_msgs/msg/inspva.hpp"    // GPS/IMUæ•°æ®ï¼ˆNovatelæ ¼å¼ï¼‰
#include "novatel_pkg/msg/net_param.hpp"        // ç½‘ç»œå‚æ•°æ¶ˆæ¯
#include "novatel_pkg/msg/radar_mount_info.hpp" // é›·è¾¾æŒ‚è½½ä¿¡æ¯æ¶ˆæ¯

#define TEST_MODE (0U)  // 0=æ­£å¸¸æ¨¡å¼ï¼Œ1=æµ‹è¯•æ¨¡å¼ï¼ˆå†…éƒ¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
```

**INSPVAæ˜¯ä»€ä¹ˆï¼Ÿ**
- Novatel OEM7èŠ¯ç‰‡çš„**æ ‡å‡†è¾“å‡ºæ¶ˆæ¯æ ¼å¼**
- åŒ…å«GPSä½ç½®ã€é€Ÿåº¦ã€åŠ é€Ÿåº¦ã€å§¿æ€ï¼ˆroll/pitch/yawï¼‰ç­‰ä¿¡æ¯
- è¿™é‡Œä¸»è¦ç”¨åˆ°ï¼š`east_velocity`ã€`north_velocity`ã€`azimuth`ã€`gps_week_milliseconds`

---

### ç¬¬äºŒéƒ¨åˆ†ï¼šæ„é€ å‡½æ•° - åˆå§‹åŒ–ï¼ˆç¬¬26-92è¡Œï¼‰

```cpp
novatel_imu(const std::string& node_name) : Node(node_name) {
```

**ç¬¬ä¸€æ­¥ï¼šå»ºç«‹UDPè¿æ¥**

```cpp
int ret = -1;
int max_attempts = 65535;
for (int attempt = 50000; attempt < max_attempts; attempt++) {
    ret = udp_io.initUdpUnicastClient("192.168.2.61", 42404, attempt);
    if (ret == 0) {
        RCLCPP_INFO(get_logger(), "æˆåŠŸç»‘å®šæœ¬åœ°ç«¯å£: %d", attempt);
        break;
    }
}
```

**åšäº†ä»€ä¹ˆï¼Ÿ**
- ç›®æ ‡ï¼šè¿æ¥åˆ°Novatel GPSè®¾å¤‡ï¼ˆIPåœ°å€ï¼š192.168.2.61ï¼Œç«¯å£ï¼š42404ï¼‰
- æ–¹æ³•ï¼šå°è¯•ä»æœ¬åœ°ç«¯å£50000å¼€å§‹ï¼Œé€ä¸ªå°è¯•ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ç«¯å£
- åŸå› ï¼šå¯èƒ½æœ‰å¤šä¸ªUDPå®¢æˆ·ç«¯éœ€è¦ä¸åŒçš„æœ¬åœ°ç«¯å£ï¼Œè‡ªåŠ¨åŒ–å¯»æ‰¾é¿å…ç«¯å£å†²çª
- ç»“æœï¼šæˆåŠŸæ—¶ç»‘å®šåˆ°æŸä¸ªæœ¬åœ°ç«¯å£ï¼ˆå¦‚50023ç­‰ï¼‰ï¼Œå¤±è´¥æ—¶è¾“å‡ºé”™è¯¯

**ç¬¬äºŒæ­¥ï¼šåˆ›å»º5ä¸ªè®¢é˜…ï¼ˆif ret == 0ï¼‰**

```cpp
subscription_ = this->create_subscription<novatel_oem7_msgs::msg::INSPVA>(
    "bynav/inspva",
    10,
    std::bind(&novatel_imu::topic_callback, this, std::placeholders::_1)
);
```

| è®¢é˜…ä¸»é¢˜ | æ¶ˆæ¯ç±»å‹ | åŠŸèƒ½ | å›è°ƒå‡½æ•° |
|---------|---------|------|---------|
| `bynav/inspva` | INSPVA | GPS/IMUåŸå§‹æ•°æ® | `topic_callback()` |
| `radar_223f/resetIP` | String | é‡ç½®é›·è¾¾IPå‘½ä»¤ | `reset_radarIp()` |
| `radar_223f/setIP` | NetParam | è®¾ç½®é›·è¾¾IPé…ç½® | `set_radarIp()` |
| `radar_223f/setRadarMountInfo` | RadarMountInfo | é…ç½®é›·è¾¾å®‰è£…å‚æ•° | `set_RadarMountInfo()` |
| `loaderStatus` | String | è½¦è¾†æ¡£ä½ä¿¡æ¯ | `set_EgoGearStatus()` |

**"è´¨é‡ç­‰çº§(QoS) = 10"æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ**
- è¡¨ç¤ºç¼“å†²æœ€å¤š10æ¡æ¶ˆæ¯
- å³ä½¿æŸæ¡æ¶ˆæ¯æ¥æ™šäº†ï¼ŒèŠ‚ç‚¹ä¹Ÿèƒ½å¤„ç†æœ€è¿‘10æ¡å†å²æ¶ˆæ¯

---

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šæˆå‘˜å˜é‡ï¼ˆç¬¬143-159è¡Œï¼‰

```cpp
rclcpp::Subscription<...>::SharedPtr resetIp_subscription_;    // è®¢é˜…æŒ‡é’ˆ
UdpInterface udp_io;                    // UDPæ¥å£å¯¹è±¡
uint16_t packageNum = 0;                // åŒ…è®¡æ•°å™¨ï¼ˆè‡ªå¢ï¼‰
float azimuthPre = 0.0f;                // ä¸Šä¸€å¸§çš„æ–¹ä½è§’
uint32_t preTime = 0;                   // ä¸Šä¸€å¸§çš„æ—¶é—´æˆ³
float deltaT = 0.05f;                   // ä¸¤å¸§é—´æ—¶é—´å·®ï¼ˆç§’ï¼‰
volatile int16_t ego_gearStatus = 1;    // å½“å‰æ¡£ä½ï¼ˆ0=å€’è½¦, 1=ç©ºæ¡£, 2=å‰è¿›, 3=åœæ³Šï¼‰
```

**å…³é”®å˜é‡è¯´æ˜**

| å˜é‡ | ç±»å‹ | ç”¨é€” |
|------|------|------|
| `packageNum` | uint16_t | æ¯æ¬¡å‘é€æ•°æ®éƒ½ä¼šè‡ªå¢ï¼Œç”¨äºé›·è¾¾è¿½è¸ªåŒ…åºåˆ— |
| `azimuthPre` | float | å­˜å‚¨ä¸Šä¸€å¸§çš„æ–¹ä½è§’ï¼Œç”¨æ¥è®¡ç®—è½¬å‘è§’é€Ÿåº¦ |
| `deltaT` | float | ç›¸é‚»ä¸¤å¸§çš„æ—¶é—´é—´éš”ï¼Œç”¨äºè®¡ç®—è§’é€Ÿåº¦ï¼ˆrad/sï¼‰ |
| `ego_gearStatus` | volatile int16_t | è½¦è¾†æ¡£ä½ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¿®æ”¹ï¼Œæ‰€ä»¥ç”¨`volatile` |

---

### ç¬¬å››éƒ¨åˆ†ï¼šå·¥å…·å‡½æ•°

#### 1. IPå­—ç¬¦ä¸²è½¬å­—èŠ‚æ•°ç»„ï¼ˆç¬¬164-173è¡Œï¼‰

```cpp
std::vector<uint8_t> ip_string_to_bytes(const std::string& ip_str) {
    std::vector<uint8_t> bytes;
    std::istringstream iss(ip_str);
    std::string segment;
    
    while (std::getline(iss, segment, '.')) {
        bytes.push_back(static_cast<uint8_t>(std::stoi(segment)));
    }
    return bytes;
}
```

**ä¾‹å­**ï¼š
```
è¾“å…¥ï¼š"192.168.2.61"
å¤„ç†ï¼šæŒ‰'.'åˆ†å‰² â†’ ["192", "168", "2", "61"]
è½¬æ¢ï¼š[192, 168, 2, 61] (uint8_tæ•°ç»„)
```

#### 2. æ ¡éªŒå’Œè®¡ç®—ï¼ˆç¬¬176-185è¡Œï¼‰

```cpp
uint8_t calc_checkSum(uint8_t* p_data_buf, uint16_t data_buf_size) {
    uint16_t check_sum = 0;
    for (index = 0U; index <= data_buf_size; index++) {
        check_sum += p_data_buf[index];
    }
    return (uint8_t)check_sum;  // åªå–ä½8ä½
}
```

**ä½œç”¨**ï¼šé”™è¯¯æ£€æµ‹
- æ‰€æœ‰æ•°æ®å­—èŠ‚ç›¸åŠ 
- åªä¿ç•™ä½8ä½ä½œä¸ºæ ¡éªŒç 
- é›·è¾¾æ¥æ”¶æ—¶é‡æ–°è®¡ç®—æ ¡éªŒç ï¼ŒéªŒè¯æ•°æ®å®Œæ•´æ€§

**ä¾‹å­**ï¼š
```
æ•°æ®ï¼š[0xAA, 0x31, 0x00, 0x20, ...]
æ ¡éªŒå’Œï¼š0xAA + 0x31 + 0x00 + 0x20 + ... = 0x1A3
æ ¡éªŒç ï¼š0xA3ï¼ˆå–ä½8ä½ï¼‰
```

#### 3. JSONè§£æï¼ˆç¬¬188-207è¡Œï¼‰

```cpp
bool parse_json_data(const std::string& json_str, jsonKV_t& data) {
    std::map<std::string, std::regex> patterns = {
        {"gear", std::regex("\"gear\":\\s*\"([^\"]+)\"")}
    };
    
    std::smatch matches;
    if (std::regex_search(json_str, matches, patterns["gear"]) && matches.size() > 1) {
        data.json_key = "gear";
        data.json_value = matches[1].str();
        return true;
    }
    return false;
}
```

**åŠŸèƒ½**ï¼šä»JSONå­—ç¬¦ä¸²ä¸­æå–æ¡£ä½ä¿¡æ¯

**ä¾‹å­**ï¼š
```
è¾“å…¥ï¼š{"gear": "d", "speed": 60}
æ­£åˆ™è¡¨è¾¾å¼ï¼šæŸ¥æ‰¾ "gear":"å€¼"
è¾“å‡ºï¼šgear = "d"
```

---

### ç¬¬äº”éƒ¨åˆ†ï¼šæ ¸å¿ƒå›è°ƒå‡½æ•° - GPS/IMUæ•°æ®å¤„ç†ï¼ˆç¬¬384-448è¡Œï¼‰

è¿™æ˜¯**æœ€é‡è¦çš„å‡½æ•°**ï¼Œæ¯æ”¶åˆ°ä¸€æ¡INSPVAæ¶ˆæ¯å°±æ‰§è¡Œä¸€æ¬¡ã€‚

#### æ•°æ®æµç¨‹å›¾

```
INSPVAæ¶ˆæ¯ (Novatel GPS)
    â†“
    â”œâ”€ east_velocity    (ä¸œå‘é€Ÿåº¦)
    â”œâ”€ north_velocity   (åŒ—å‘é€Ÿåº¦)
    â”œâ”€ azimuth          (æ–¹ä½è§’)
    â””â”€ gps_week_milliseconds (æ—¶é—´æˆ³)
    â†“
topic_callback() {
    è®¡ç®— â†’ è½¦é€Ÿã€åèˆªè§’é€Ÿåº¦
    æ‰“åŒ… â†’ äºŒè¿›åˆ¶åè®®æ•°æ®
    å‘é€ â†’ UDP to RA223F
}
    â†“
32å­—èŠ‚çš„äºŒè¿›åˆ¶æ•°æ®åŒ…
```

#### è¯¦ç»†æ­¥éª¤

**ç¬¬1æ­¥ï¼šåˆå§‹åŒ–æ•°æ®ç¼“å†²åŒºï¼ˆç¬¬386-391è¡Œï¼‰**

```cpp
uint8_t data_buf[32] = {0x00};  // 32ä¸ªå­—èŠ‚ï¼Œå…¨éƒ¨åˆå§‹åŒ–ä¸º0
data_buf[0] = 0xAA;             // åè®®å¤´ï¼ˆå›ºå®šå€¼ï¼‰
data_buf[1] = 0x31;             // æ¶ˆæ¯ç±»å‹ï¼š0x31è¡¨ç¤º"å‘é€è½¦é€Ÿå’Œåèˆªç‡"
data_buf[2] = 0x00;             // é¢„ç•™å­—èŠ‚
data_buf[3] = 32;               // æ•°æ®æœ‰æ•ˆé•¿åº¦ï¼ˆå­—èŠ‚æ•°ï¼‰
```

**åè®®æ ¼å¼ï¼š**
```
å­—èŠ‚ 0-3ï¼šæ¶ˆæ¯å¤´ï¼ˆ4å­—èŠ‚ï¼‰
  [0]: 0xAA       (å›ºå®šå¸§å¤´)
  [1]: 0x31       (æ¶ˆæ¯ç±»å‹ID)
  [2]: 0x00       (é¢„ç•™)
  [3]: 32         (æ•°æ®é•¿åº¦)

å­—èŠ‚ 4-31ï¼šæ•°æ®ä½“ï¼ˆ28å­—èŠ‚ï¼‰
  [4-5]:   packageNum   (2å­—èŠ‚ï¼ŒåŒ…åºåˆ—å·)
  [6-7]:   yawRate      (2å­—èŠ‚ï¼Œåèˆªè§’é€Ÿåº¦)
  [8-9]:   velocity     (2å­—èŠ‚ï¼Œè½¦é€Ÿ)
  [10-15]: é¢„ç•™         (6å­—èŠ‚)
  [16-17]: gearStatus   (2å­—èŠ‚ï¼Œæ¡£ä½)
  [18-30]: é¢„ç•™
  [31]:    checkSum     (1å­—èŠ‚ï¼Œæ ¡éªŒç )
```

**ç¬¬2æ­¥ï¼šè®¡ç®—è½¦é€Ÿï¼ˆç¬¬414è¡Œï¼‰**

```cpp
vel = sqrtf((p_novatelAtt->east_velocity * p_novatelAtt->east_velocity) + 
            (p_novatelAtt->north_velocity * p_novatelAtt->north_velocity));
```

**ä¸ºä»€ä¹ˆï¼Ÿ**
- GPSç»™å‡ºçš„æ˜¯**ä¸œå‘é€Ÿåº¦**å’Œ**åŒ—å‘é€Ÿåº¦**ï¼ˆåˆ†é‡å½¢å¼ï¼‰
- éœ€è¦åˆæˆä¸º**æ ‡é‡é€Ÿåº¦**ï¼ˆå¤§å°ï¼‰
- å…¬å¼ï¼šv = âˆš(vxÂ² + vyÂ²)

**å…·ä½“ä¾‹å­**ï¼š
```
ä¸œå‘é€Ÿåº¦ï¼š20 m/sï¼ˆå‘ä¸œè·‘ï¼‰
åŒ—å‘é€Ÿåº¦ï¼š15 m/sï¼ˆå‘åŒ—è·‘ï¼‰
åˆæˆé€Ÿåº¦ï¼šâˆš(20Â² + 15Â²) = âˆš(400 + 225) = âˆš625 = 25 m/s
```

**ç¬¬3æ­¥ï¼šè®¡ç®—åèˆªè§’é€Ÿåº¦ï¼ˆç¬¬406-424è¡Œï¼‰**

```cpp
//è·å–æ—¶é—´å·®
uint32_t curTime = p_novatelAtt->nov_header.gps_week_milliseconds;
if(curTime > preTime){
    deltaT = (curTime - preTime) / 1000.f;  // æ¯«ç§’è½¬ç§’
} else {
    deltaT = 0.05f;  // é»˜è®¤50ms
}
preTime = curTime;

//è®¡ç®—æ–¹ä½è§’å˜åŒ–
deltaAzimuth = p_novatelAtt->azimuth - azimuthPre;

//å¤„ç† Â±180Â° çš„è·³å˜
if (deltaAzimuth > 180.f) {
    deltaAzimuth -= 360.f;
} else if(deltaAzimuth < -180.f) {
    deltaAzimuth += 360.f;
}

//è®¡ç®—è§’é€Ÿåº¦ï¼ˆrad/sï¼‰
yawRate = -((deltaAzimuth)/180.f * M_PI) / deltaT;
azimuthPre = p_novatelAtt->azimuth;
```

**è¯¦ç»†è§£é‡Š**

ç¬¬1æ­¥ï¼šè®¡ç®—ä¸¤å¸§æ—¶é—´é—´éš”
```
curTime = 123456 (ms)    // å½“å‰æ—¶é—´æˆ³
preTime = 123406 (ms)    // ä¸Šä¸€å¸§æ—¶é—´æˆ³
deltaT = (123456 - 123406) / 1000.0 = 0.05 s (50æ¯«ç§’)
```

ç¬¬2æ­¥ï¼šè®¡ç®—æ–¹ä½è§’å˜åŒ–
```
å½“å‰æ–¹ä½è§’ï¼š350Â° (å‘åŒ—åè¥¿)
ä¸Šä¸€å¸§æ–¹ä½è§’ï¼š10Â° (å‘åŒ—åä¸œ)
åŸå§‹å·®å€¼ï¼š350 - 10 = 340Â°

é—®é¢˜ï¼šè¿™æ ·è®¡ç®—ä¼šè®¤ä¸ºè½¦çŒ›è½¬340Â°ï¼
å®é™…ä¸Šï¼šè½¦åªè½¬äº† -20Â°ï¼ˆé¡ºæ—¶é’ˆè½¬ï¼‰

å¤„ç†æ–¹æ³•ï¼ˆè§’åº¦å½’ä¸€åŒ–ï¼‰ï¼š
if (340 > 180) â†’ 340 - 360 = -20Â° âœ“ æ­£ç¡®ï¼
```

ç¬¬3æ­¥ï¼šè®¡ç®—è§’é€Ÿåº¦
```
æ–¹ä½è§’å˜åŒ–ï¼š-20Â° 
æ—¶é—´é—´éš”ï¼š0.05 s
è½¬æ¢å•ä½ï¼š-20Â° = -20 * Ï€/180 rad = -0.349 rad
è§’é€Ÿåº¦ï¼š-0.349 / 0.05 = -6.98 rad/s

è´Ÿå·è¡¨ç¤ºé¡ºæ—¶é’ˆè½¬å‘
```

**ç¬¬4æ­¥ï¼šæ‰“åŒ…æ•°æ®ï¼ˆç¬¬410-438è¡Œï¼‰**

```cpp
//åŒ…åºåˆ—å·ï¼ˆè‡ªå¢è®¡æ•°ï¼‰
data_buf[4] = (packageNum & 0xFF00) >> 8;   // é«˜å­—èŠ‚
data_buf[5] = packageNum & 0x00FF;          // ä½å­—èŠ‚

//åèˆªè§’é€Ÿåº¦ï¼ˆint16_tæ ¼å¼ï¼Œå•ä½Ã—10000ï¼‰
yawRateInt = (int16_t)(yawRate * 10000.f);
data_buf[6] = (yawRateInt & 0xFF00) >> 8;
data_buf[7] = yawRateInt & 0x00FF;

//è½¦é€Ÿï¼ˆint16_tæ ¼å¼ï¼Œå•ä½Ã—100ï¼‰
speedInt = (int16_t)(vel * 100.f);
data_buf[8] = (speedInt & 0xFF00) >> 8;
data_buf[9] = speedInt & 0x00FF;

//æ¡£ä½ï¼ˆ2å­—èŠ‚ï¼‰
data_buf[16] = this->ego_gearStatus >> 8;
data_buf[17] = this->ego_gearStatus & 0x00ff;
```

**æ•°æ®ç¼–ç ç¤ºä¾‹**

```
packageNum = 258
  â†’ 0x0102 (16è¿›åˆ¶)
  â†’ data_buf[4] = 0x01, data_buf[5] = 0x02

yawRate = -6.98 rad/s
  â†’ yawRateInt = (int16_t)(-6.98 * 10000) = -69800
  â†’ -69800 = 0xFFFEE2D8 (è¡¥ç è¡¨ç¤º)
  â†’ data_buf[6] = 0xEE, data_buf[7] = 0x2D

velocity = 25 m/s
  â†’ speedInt = (int16_t)(25 * 100) = 2500
  â†’ 0x09C4 (16è¿›åˆ¶)
  â†’ data_buf[8] = 0x09, data_buf[9] = 0xC4

gear = 2 (å‰è¿›)
  â†’ data_buf[16] = 0x00, data_buf[17] = 0x02
```

**ç¬¬5æ­¥ï¼šè®¡ç®—å¹¶å‘é€ï¼ˆç¬¬441-443è¡Œï¼‰**

```cpp
data_buf[31] = this->calc_checkSum(&data_buf[0], 31);  // æ ¡éªŒç 
udp_io.sendToRadar((char*) data_buf, 32, 200);         // å‘é€ï¼Œè¶…æ—¶200ms
packageNum++;  // åºåˆ—å·è‡ªå¢
```

---

### ç¬¬å…­éƒ¨åˆ†ï¼šé…ç½®ç±»å›è°ƒå‡½æ•°

#### 1. è®¾ç½®é›·è¾¾æŒ‚è½½ä¿¡æ¯ï¼ˆç¬¬237-294è¡Œï¼‰

```cpp
void set_RadarMountInfo(const novatel_pkg::msg::RadarMountInfo::SharedPtr p_msg)
```

**åè®®æ ¼å¼**ï¼š64å­—èŠ‚
```
[0-3]:   æ¶ˆæ¯å¤´ (0xAA 0x30 0x00 32)
[4-5]:   è®¡æ•°å™¨ radarMount_count
[6-7]:   Xä½ç§» (mount_xpos Ã— 100, int16_t) - çºµå‘è·ç¦»
[8-9]:   Yä½ç§» (mount_ypos Ã— 100, int16_t) - æ¨ªå‘è·ç¦»
[10-11]: Zä½ç§» (mount_zpos Ã— 100, int16_t) - ç«–ç›´è·ç¦»
[12-13]: Yawè§’ (raw_yaw_angle Ã— 100, int16_t) - åèˆªå®‰è£…è§’
[14-15]: Pitchè§’ (raw_pitch_angle Ã— 100, int16_t) - ä¿¯ä»°å®‰è£…è§’
[16-17]: è½¦å®½ (car_width Ã— 100, int16_t)
[18-19]: è½¦é•¿ (car_length Ã— 100, int16_t)
[20-21]: è½¦é«˜ (car_height Ã— 100, int16_t)
[22-23]: è½´è· (car_wheelbase Ã— 100, int16_t)
[24]:    è£…è®¢æ“ä½œ (0x00)
[25-30]: é¢„ç•™
[31]:    æ ¡éªŒå’Œ
```

**å®é™…ä¾‹å­**ï¼š
```
å‰ä¿é™©æ å®‰è£…é›·è¾¾ï¼š
  Xè·ç¦»ï¼š0.5m  â†’ 50 (Ã—100) â†’ 0x0032
  Yè·ç¦»ï¼š0m    â†’ 0         â†’ 0x0000
  Zè·ç¦»ï¼š0.6m  â†’ 60 (Ã—100) â†’ 0x003C
  
  æ•°æ®æ‰“åŒ…ï¼š
  [6] = 0x00, [7] = 0x32  (X = 0.5m)
  [8] = 0x00, [9] = 0x00  (Y = 0m)
  [10] = 0x00, [11] = 0x3C (Z = 0.6m)
```

#### 2. è®¾ç½®é›·è¾¾IPåœ°å€ï¼ˆç¬¬297-349è¡Œï¼‰

```cpp
void set_radarIp(const novatel_pkg::msg::NetParam::SharedPtr p_msg)
```

**åè®®æ ¼å¼**ï¼š64å­—èŠ‚
```
[0-3]:    æ¶ˆæ¯å¤´ (0xAA 0x8A 0x00 64)
[4-5]:    è®¡æ•°å™¨
[6-9]:    é›·è¾¾IPåœ°å€ (4ä¸ªå­—èŠ‚)
[10-13]:  æœ¬åœ°IPåœ°å€ (4ä¸ªå­—èŠ‚)
[14-17]:  ç½‘å…³åœ°å€ (4ä¸ªå­—èŠ‚)
[18-21]:  å­ç½‘æ©ç  (å›ºå®š 255.255.255.0)
[22-23]:  PCæ¥æ”¶ç«¯å£ (uint16_t)
[24-25]:  é›·è¾¾æ¥æ”¶ç«¯å£ (uint16_t)
[26-27]:  é›·è¾¾å‘é€ç«¯å£ (uint16_t)
[28]:     æ“ä½œæ ‡å¿— (0x00 = IPè®¾ç½®)
[29-62]:  é¢„ç•™
[63]:     æ ¡éªŒå’Œ
```

**å…·ä½“ä¾‹å­**ï¼š
```
NetParam {
  radar_ip: "10.13.2.115"
  local_ip: "10.13.2.250"
  gateway: "255.255.255.0"
  radar_receive_port: 4004
  pc_receive_port: 42104
  radar_send_port: 4003
}

è½¬æ¢ï¼š
data_buf[6] = 10,  [7] = 13,  [8] = 2,   [9] = 115
data_buf[10] = 10, [11] = 13, [12] = 2,  [13] = 250
data_buf[14] = 255, [15] = 255, [16] = 255, [17] = 0
data_buf[22-23] = 42104 â†’ 0xA4 0x68
```

#### 3. é‡ç½®é›·è¾¾IPï¼ˆç¬¬360-380è¡Œï¼‰

```cpp
void reset_radarIp(const std_msgs::msg::String::SharedPtr msg)
```

**åè®®æ ¼å¼**ï¼š64å­—èŠ‚
```
[0-3]:    æ¶ˆæ¯å¤´ (0xAA 0x8A 0x00 64)
[4-5]:    è®¡æ•°å™¨
[6-27]:   éƒ½æ˜¯0x00
[28]:     æ“ä½œæ ‡å¿— (0x01 = IPå¤ä½)
[29-62]:  é¢„ç•™
[63]:     æ ¡éªŒå’Œ
```

**æ•ˆæœ**ï¼š
- é›·è¾¾IPæ¢å¤åˆ°é»˜è®¤å€¼ï¼ˆé€šå¸¸æ˜¯192.168.x.xç³»åˆ—ï¼‰
- ç”¨äºæ•…éšœæ’æŸ¥æˆ–é‡æ–°é…ç½®ç½‘ç»œ

#### 4. è®¾ç½®è½¦è¾†æ¡£ä½ï¼ˆç¬¬212-234è¡Œï¼‰

```cpp
void set_EgoGearStatus(const std_msgs::msg::String::SharedPtr p_msg)
```

**å¤„ç†æµç¨‹**ï¼š
```cpp
JSONè¾“å…¥ï¼š{"gear": "d"}
        â†“
regex è§£æï¼šgear = "d"
        â†“
æ˜ å°„è½¬æ¢ï¼š
  "r" â†’ gearStatus = 0  (å€’è½¦)
  "n" â†’ gearStatus = 1  (ç©ºæ¡£)
  "d" â†’ gearStatus = 2  (å‰è¿›)
  "p" â†’ gearStatus = 3  (åœæ³Š)
        â†“
ä¿å­˜åˆ°ï¼švolatile int16_t ego_gearStatus = 2

å¤‡æ³¨ï¼švolatile ä¿®é¥°ç¬¦å¾ˆé‡è¦ï¼
      å¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è®¿é—®è¿™ä¸ªå˜é‡ï¼š
      - topic_callback() å†™å…¥ gear çŠ¶æ€
      - GPSæ•°æ®å¤„ç†çº¿ç¨‹ è¯»å– gear çŠ¶æ€
      volatile ç¡®ä¿æ¯æ¬¡éƒ½ä»å†…å­˜è¯»å–æœ€æ–°å€¼
```

---

### ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæµ‹è¯•æ¨¡å¼ï¼ˆç¬¬107-140è¡Œï¼‰

```cpp
#if (TEST_MODE == 1U)  // åªåœ¨æµ‹è¯•æ¨¡å¼ä¸‹ç¼–è¯‘
    void timer_callback() {
        // æ¯1ç§’æ‰§è¡Œä¸€æ¬¡
        // å‘å¸ƒæ¨¡æ‹Ÿçš„resetIPã€setIPã€setRadarMountInfoæ¶ˆæ¯
        
        pub_setIpPtr_->publish({
            .radar_ip = "10.13.2.115",
            .local_ip = "10.13.2.250",
            .gateway = "255.255.255.0",
            .radar_receive_port = 4004,
            ...
        });
    }
#endif
```

**ç”¨é€”**ï¼š
- ä¸éœ€è¦çœŸå®GPS/IMUç¡¬ä»¶ä¹Ÿèƒ½æµ‹è¯•ä»£ç 
- å®šæ—¶å™¨æ¯ç§’å‘å¸ƒä¸€æ¡é…ç½®æ¶ˆæ¯
- éªŒè¯é…ç½®ä¸‹å‘æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

## ğŸ“Š å®Œæ•´çš„æ•°æ®æµåŠ¨é“¾è·¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Novatel GPS/IMU    â”‚
â”‚  (ç¡¬ä»¶è®¾å¤‡)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ UDP (192.168.2.61:42404)
           â”‚ INSPVAæ¶ˆæ¯
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  novatel_imu èŠ‚ç‚¹               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è®¢é˜… bynav/inspva                â”‚
â”‚   â†“ topic_callback()             â”‚
â”‚   â”œâ”€ è®¡ç®—è½¦é€Ÿ                    â”‚
â”‚   â”œâ”€ è®¡ç®—åèˆªè§’é€Ÿåº¦              â”‚
â”‚   â”œâ”€ æ‰“åŒ…32å­—èŠ‚äºŒè¿›åˆ¶æ•°æ®        â”‚
â”‚   â””â”€ UDPå‘é€                     â”‚
â”‚                                  â”‚
â”‚ è®¢é˜… loaderStatus                â”‚
â”‚   â†“ set_EgoGearStatus()          â”‚
â”‚   â””â”€ è§£ææ¡£ä½ä¿¡æ¯                â”‚
â”‚                                  â”‚
â”‚ è®¢é˜… radar_223f/setIP            â”‚
â”‚   â†“ set_radarIp()                â”‚
â”‚   â””â”€ æ‰“åŒ…64å­—èŠ‚IPé…ç½®æ•°æ®        â”‚
â”‚                                  â”‚
â”‚ è®¢é˜… radar_223f/setRadarMountInfoâ”‚
â”‚   â†“ set_RadarMountInfo()         â”‚
â”‚   â””â”€ æ‰“åŒ…64å­—èŠ‚å®‰è£…å‚æ•°æ•°æ®      â”‚
â”‚                                  â”‚
â”‚ è®¢é˜… radar_223f/resetIP          â”‚
â”‚   â†“ reset_radarIp()              â”‚
â”‚   â””â”€ æ‰“åŒ…64å­—èŠ‚é‡ç½®æ•°æ®          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ UDP (192.168.x.x:xxx)
             â”‚ äºŒè¿›åˆ¶åè®®æ•°æ®
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  RA223F é›·è¾¾     â”‚
    â”‚  (ç¡¬ä»¶è®¾å¤‡)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€ æ›´æ–°è½¦é€Ÿ/è§’é€Ÿåº¦
             â”œâ”€ é‡æ–°é…ç½®ç½‘ç»œ
             â”œâ”€ è®¾ç½®å®‰è£…å‚æ•°
             â””â”€ æ”¹è¿›ç›®æ ‡æ£€æµ‹ç®—æ³•
```

---

## ğŸ”‘ å…³é”®çš„è®¾è®¡æ¨¡å¼

### 1. åè®®é€‚é…å™¨æ¨¡å¼

```
é«˜çº§ ROS2 æ¶ˆæ¯          åº•å±‚ç¡¬ä»¶åè®®
â”œâ”€ INSPVA              â†’ 32å­—èŠ‚äºŒè¿›åˆ¶
â”œâ”€ NetParam            â†’ 64å­—èŠ‚äºŒè¿›åˆ¶
â””â”€ RadarMountInfo      â†’ 64å­—èŠ‚äºŒè¿›åˆ¶
```

### 2. çº¿ç¨‹å®‰å…¨

```cpp
volatile int16_t ego_gearStatus = 1;
```
- `volatile` ç¡®ä¿å¤šçº¿ç¨‹è®¿é—®æ—¶æ¯æ¬¡éƒ½è¯»å†™å†…å­˜
- é¿å…CPUç¼“å­˜å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´

### 3. é”™è¯¯æ¢å¤

```cpp
if(curTime > preTime){
    deltaT = (curTime - preTime) / 1000.f;
} else {
    deltaT = 0.05f;  // é»˜è®¤å€¼ï¼ˆä¿å®ˆä¼°è®¡ï¼‰
}
```
- å¦‚æœæ—¶é—´æˆ³å¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤å€¼ç»§ç»­è¿è¡Œ
- æé«˜ç³»ç»Ÿå®¹é”™èƒ½åŠ›

### 4. åè®®æ ¡éªŒ

```cpp
data_buf[31] = this->calc_checkSum(&data_buf[0], 31);
```
- é˜²æ­¢ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ•°æ®æŸå
- é›·è¾¾æ¥æ”¶æ—¶ä¼šéªŒè¯æ ¡éªŒç 

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦ç”¨ `volatile`ï¼Ÿ

```cpp
volatile int16_t ego_gearStatus = 1;
```

**ç­”**ï¼šæ²¡æœ‰ volatile çš„å±é™©æƒ…å†µï¼š

```cpp
// çº¿ç¨‹Aä¸æ–­è¯»å–
if (ego_gearStatus == 2) {
    // do something
}

// ç¼–è¯‘å™¨å¯èƒ½ä¼˜åŒ–ä¸ºï¼š
temp = ego_gearStatus;  // è¯»ä¸€æ¬¡
if (temp == 2) { ... }
if (temp == 2) { ... }  // ä½¿ç”¨ç¼“å­˜çš„å€¼ï¼Œä¸é‡æ–°è¯»å–ï¼

// ç»“æœï¼šçº¿ç¨‹Bä¿®æ”¹äº† ego_gearStatusï¼Œä½†çº¿ç¨‹Aæ²¡çœ‹åˆ°
```

**volatile è§£å†³æ–¹æ¡ˆ**ï¼š
```cpp
// æ¯æ¬¡éƒ½å¼ºåˆ¶ä»å†…å­˜è¯»å–æœ€æ–°å€¼
if (ego_gearStatus == 2) { ... }  // è¯»å†…å­˜
// ...
if (ego_gearStatus == 2) { ... }  // å†è¯»ä¸€æ¬¡å†…å­˜
```

### Q2: ä¸ºä»€ä¹ˆè½¦é€Ÿç”¨ `vel * 100`ï¼Ÿ

```cpp
speedInt = (int16_t)(vel * 100.f);  // ç²¾åº¦Ã—100
```

**ç­”**ï¼šint16_t èŒƒå›´ï¼š-32768 åˆ° 32767

```
ä¸ä¹˜ä»¥100ï¼š
  æœ€é«˜é€Ÿåº¦åªèƒ½è¡¨ç¤º 32.767 m/s â‰ˆ 118 km/h
  è¶…å‡ºèŒƒå›´ï¼

ä¹˜ä»¥100ï¼š
  ç²¾åº¦æé«˜åˆ°0.01 m/s
  æœ€é«˜é€Ÿåº¦ï¼š327.67 m/s â‰ˆ 1179 km/h ï¼ˆè¶³å¤Ÿï¼‰
  
å…¸å‹ä¾‹å­ï¼š
  å®é™…é€Ÿåº¦ï¼š25 m/s
  å­˜å‚¨å€¼ï¼š2500
  å®é™…å€¼ = å­˜å‚¨å€¼ / 100 = 25 m/s âœ“
```

### Q3: ä¸ºä»€ä¹ˆè¦å¤„ç† Â±180Â° çš„è§’åº¦è·³å˜ï¼Ÿ

```cpp
if (deltaAzimuth > 180.f) {
    deltaAzimuth -= 360.f;
}
```

**ç­”**ï¼šé¿å…è§’åº¦çªè·³ï¼š

```
æƒ…å†µ1ï¼šè½¦ä»åŒ—(0Â°)è½¬å‘å—(180Â°)
  å½“å‰æ–¹ä½ï¼š180Â°
  ä¸Šä¸€å¸§ï¼š0Â°
  åŸå§‹å·®å€¼ï¼š180 - 0 = 180Â°
  ç»“è®ºï¼šè½¬äº†180Â° âœ“ æ­£ç¡®

æƒ…å†µ2ï¼šè½¦ä»åŒ—(0Â°)å·¦è½¬åˆ°è¥¿(270Â°)
  å½“å‰æ–¹ä½ï¼š270Â°
  ä¸Šä¸€å¸§ï¼š355Â°
  åŸå§‹å·®å€¼ï¼š270 - 355 = -85Â°
  ç»“è®ºï¼šé¡ºæ—¶é’ˆè½¬äº†85Â° âœ“ æ­£ç¡®

æƒ…å†µ3ï¼šè½¦ä»è¥¿(270Â°)å³è½¬åˆ°åŒ—(0Â°)
  å½“å‰æ–¹ä½ï¼š0Â°
  ä¸Šä¸€å¸§ï¼š270Â°
  åŸå§‹å·®å€¼ï¼š0 - 270 = -270Â°
  é—®é¢˜ï¼šå®é™…åªè½¬äº†90Â°ï¼Œä½†è®¡ç®—å‡º-270Â°ï¼
  
  å¤„ç†ï¼š
  if (-270 < -180) â†’ -270 + 360 = 90Â°  âœ“ æ­£ç¡®ï¼
```

---

## ğŸ“ˆ æ•°æ®æ›´æ–°é¢‘ç‡

å‡è®¾ Novatel GPS ä»¥ 10Hz é¢‘ç‡è¾“å‡ºæ•°æ®ï¼š

```
æ—¶åˆ» 0ms:   ç¬¬1æ¡INSPVA â†’ topic_callback() â†’ å‘é€1æ¡32å­—èŠ‚æ•°æ®åˆ°é›·è¾¾
æ—¶åˆ» 100ms: ç¬¬2æ¡INSPVA â†’ topic_callback() â†’ å‘é€1æ¡32å­—èŠ‚æ•°æ®åˆ°é›·è¾¾
æ—¶åˆ» 200ms: ç¬¬3æ¡INSPVA â†’ topic_callback() â†’ å‘é€1æ¡32å­—èŠ‚æ•°æ®åˆ°é›·è¾¾
...

æ€»ç»“ï¼š
âœ“ è½¦é€Ÿã€åèˆªç‡ï¼š10Hz æ›´æ–°
âœ“ æ¡£ä½ï¼šå¼‚æ­¥æ›´æ–°ï¼ˆæœ‰æ–°æ•°æ®æ—¶ï¼‰
âœ“ IPé…ç½®ï¼šæ‰‹åŠ¨è§¦å‘
âœ“ å®‰è£…å‚æ•°ï¼šå¯åŠ¨æ—¶é…ç½®ä¸€æ¬¡
```

---

## ğŸ¯ æ€»ç»“

è¿™ä¸ªä»£ç æ˜¯ä¸€ä¸ª**å¤šåŠŸèƒ½çš„ä¸­é—´ä»¶**ï¼š

| åŠŸèƒ½ | å®ç°æ–¹å¼ |
|------|---------|
| **GPS/IMU å¤„ç†** | æ¥æ”¶INSPVAï¼Œè®¡ç®—è½¦é€Ÿå’Œè§’é€Ÿåº¦ |
| **åè®®è½¬æ¢** | å°†ROS2æ¶ˆæ¯è½¬æ¢ä¸ºé›·è¾¾äºŒè¿›åˆ¶åè®® |
| **é…ç½®ç®¡ç†** | åŠ¨æ€è®¾ç½®é›·è¾¾ç½‘ç»œã€ä½ç½®ã€å‚æ•° |
| **æ¡£ä½ç®¡ç†** | è§£æJSONæ¡£ä½ä¿¡æ¯ï¼Œå®æ—¶æ›´æ–° |
| **é”™è¯¯å¤„ç†** | æ ¡éªŒç ã€å¼‚å¸¸æ—¶çš„é»˜è®¤å€¼ |
| **æ€§èƒ½ä¼˜åŒ–** | volatileå˜é‡ã€é«˜é¢‘æ•°æ®æ‰“åŒ… |

æ ¸å¿ƒä»·å€¼ï¼š**è®©é›·è¾¾çŸ¥é“è½¦çš„çœŸå®è¿åŠ¨çŠ¶æ€ï¼Œä»è€Œåšå‡ºå‡†ç¡®çš„ç›®æ ‡æ£€æµ‹å’Œé€Ÿåº¦è¡¥å¿**ã€‚
